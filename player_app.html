<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Potato Music App</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #fff; }
    #player { width: 480px; height: 270px; margin-top: 30px; }
    #nowPlaying { font-weight: bold; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div id="nowPlaying">í˜„ì¬ ì¬ìƒ ì¤‘: ì—†ìŒ</div>
  <div id="player"></div>

  <script>
    const API_BASE = "https://potato-music.onrender.com";
    let player;
    let ws;
    let currentId = "";
    let currentTitle = "";

    function connectWebSocket() {
      ws = new WebSocket("wss://potato-music.onrender.com");

      ws.onopen = () => console.log("âœ… WebSocket ì—°ê²°ë¨");

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if ((msg.type === "play" || msg.type === "seek") && player) {
          const elapsed = Math.floor(Date.now() / 1000) - msg.startTime;

          if (currentId !== msg.id) {
            player.loadVideoById({ videoId: msg.id, startSeconds: elapsed });
            currentId = msg.id;
            currentTitle = msg.title;
          } else {
            player.seekTo(elapsed, true);
          }

          if (!msg.isPaused) {
            player.unMute?.();
            player.playVideo();
          } else {
            player.pauseVideo();
          }

          document.getElementById("nowPlaying").textContent = "í˜„ì¬ ì¬ìƒ ì¤‘: " + msg.title;
        }

        if (msg.type === "pause" && player) {
          player.pauseVideo();
        }
      };

      ws.onclose = () => {
        console.log("ğŸ”Œ WebSocket ì¢…ë£Œë¨, ì¬ì—°ê²° ì‹œë„ ì¤‘...");
        setTimeout(connectWebSocket, 2000);
      };
    }

    function syncWithServerStatus() {
      fetch(API_BASE + "/api/status")
        .then(res => res.json())
        .then(status => {
          if (!status?.id) return;

          const elapsed = Math.floor(Date.now() / 1000) - status.startTime;
          const target = {
            videoId: status.id,
            startSeconds: elapsed
          };

          if (player && typeof player.loadVideoById === 'function') {
            player.loadVideoById(target);
            if (status.isPaused) {
              player.pauseVideo();
            }
          }

          currentId = status.id;
          currentTitle = status.title;
          document.getElementById("nowPlaying").textContent = "í˜„ì¬ ì¬ìƒ ì¤‘: " + status.title;
        });
    }

    window.syncWithServerStatus = syncWithServerStatus;

    function onYouTubeIframeAPIReady() {
      player = new YT.Player("player", {
        height: "270",
        width: "480",
        videoId: "",
          playerVars: {
            autoplay: 1,
            start: startTime,
            controls: 0,         // â¬…ï¸ ì‚¬ìš©ì ì»¨íŠ¸ë¡¤ ì œê±°
            disablekb: 1,        // â¬…ï¸ í‚¤ë³´ë“œ ì œì–´ ë¹„í™œì„±í™”
            modestbranding: 1,   // â¬…ï¸ YouTube ë¡œê³  ì œê±°
            rel: 0               // â¬…ï¸ ê´€ë ¨ ë™ì˜ìƒ ìˆ¨ê¹€
          },
        events: {
          onReady: () => {
            syncWithServerStatus();
          }
        }
      });
    }

    connectWebSocket();

    const tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
  </script>
</body>
</html>
