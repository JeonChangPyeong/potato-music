<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>내 노래 재생기</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }

    #player {
      width: 100%;
      height: 200px;
      margin-bottom: 20px;
    }

    ul {
      padding: 0;
      list-style: none;
    }

    li {
      margin-bottom: 8px;
      background: #fff;
      padding: 8px;
      border-radius: 4px;
      cursor: grab;
      transition: background 0.2s ease;
    }

    li.dragging {
      background-color: #ffebc6;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      opacity: 0.8;
    }

    button {
      margin-left: 6px;
    }
  </style>
</head>
<body>

  <h2>노래 재생기 🎵</h2>

  <!-- YouTube 플레이어 -->
  <div id="player"></div>

  <h3>노래 리스트 (드래그 가능)</h3>
  <ul id="songList"></ul>

  <h4>노래 추가하기</h4>
  <input type="text" id="newTitle" placeholder="노래 제목">
  <input type="text" id="newSong" placeholder="YouTube 링크">
  <button onclick="addSong()">추가</button>

  <!-- SortableJS 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <script>
    let songs = [];
    let player;
    const STORAGE_KEY = 'my-song-list';

    function saveSongs() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(songs));
    }

    function loadSongs() {
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) songs = JSON.parse(data);
    }

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '200',
        width: '100%',
        videoId: songs[0]?.id || '',
        events: {
          'onReady': () => {
            if (songs.length > 0) playSong(0);
          },
          'onStateChange': onPlayerStateChange
        },
        playerVars: {
          autoplay: 1,
          loop: 0,
          rel: 0
        }
      });
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.ENDED) {
        songs.shift();
        saveSongs();
        renderSongs();
        if (songs.length > 0) playSong(0);
        else player.stopVideo();
      }
    }

    function playSong(index) {
      if (songs[index]) player.loadVideoById(songs[index].id);
    }

    function deleteSong(index) {
      songs.splice(index, 1);
      saveSongs();
      renderSongs();
      if (index === 0 && songs.length > 0) playSong(0);
    }

    function addSong() {
      const titleInput = document.getElementById("newTitle");
      const urlInput = document.getElementById("newSong");
      const title = titleInput.value.trim() || `노래 ${songs.length + 1}`;
      const url = urlInput.value.trim();
      const match = url.match(/v=([^&]+)/);

      if (match) {
        const id = match[1];
        songs.push({ title, id });
        saveSongs();
        renderSongs();

        if (songs.length === 1) playSong(0);

        titleInput.value = '';
        urlInput.value = '';
      } else {
        alert("올바른 유튜브 링크를 입력하세요.");
      }
    }

    function renderSongs() {
      const list = document.getElementById("songList");
      list.innerHTML = '';
      songs.forEach((song, index) => {
        const li = document.createElement("li");
        li.setAttribute('data-index', index);
        li.innerHTML = `
          ${song.title}
          <button onclick="playSong(${index})">재생</button>
          <button onclick="deleteSong(${index})">삭제</button>`;
        list.appendChild(li);
      });

      // 드래그 앤 드롭 기능
      Sortable.create(list, {
        animation: 150,
        onStart: function (evt) {
          evt.item.classList.add('dragging');
        },
        onEnd: function (evt) {
          evt.item.classList.remove('dragging');

          const oldIndex = evt.oldIndex;
          const newIndex = evt.newIndex;
          if (oldIndex === newIndex) return;

          const moved = songs.splice(oldIndex, 1)[0];
          songs.splice(newIndex, 0, moved);

          saveSongs();
          renderSongs(); // 인덱스 리셋
        }
      });
    }

    // 초기 로딩
    loadSongs();
    renderSongs();

    // YouTube API 스크립트 로드
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
  </script>

</body>
</html>
