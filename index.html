<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í¬í…Œì´í†  ë®¤ì§ ê´€ë¦¬ì</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9f9f9;
      padding: 30px;
    }
    h2 {
      color: #333;
    }
    .section {
      margin-top: 40px;
    }
    .controls button {
      padding: 8px 14px;
      margin-right: 8px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .controls input {
      width: 60px;
      padding: 6px;
      margin-right: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th {
      background: #f2f2f2;
    }
    tr.highlight {
      background-color: #e1f5fe !important;
    }
    .add-section input {
      padding: 8px;
      margin-right: 10px;
    }
    .add-section button {
      padding: 8px 16px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
    }
    tr.dragging {
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <h2>í¬í…Œì´í†  ë®¤ì§ ê´€ë¦¬ì í˜ì´ì§€</h2>

  <div class="section controls">
    <button onclick="play()">â–¶ï¸ ì¬ìƒ</button>
    <button onclick="pause()">â¸ï¸ ì¼ì‹œì •ì§€</button>
    <button onclick="next()">â­ï¸ ë‹¤ìŒ ê³¡</button>
    <input type="number" id="seekSeconds" value="30" />
    <button onclick="seek()">í™”ìƒ ì‹œì»¨</button>
  </div>

  <div class="section">
    <h3>ğŸ“‹ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</h3>
    <table>
      <thead>
        <tr><th>ì œëª©</th><th>Video ID</th><th>ì‘ì—…</th></tr>
      </thead>
      <tbody id="playlistTable"></tbody>
    </table>
  </div>

  <div class="section add-section">
    <h3>â• ê³¡ ì¶”ê°€</h3>
    <input id="videoIdInput" placeholder="YouTube Video ID" />
    <input id="titleInput" placeholder="ê³¡ ì œëª©" />
    <button onclick="addSong()">ì¶”ê°€</button>
  </div>

  <script>
    const API = "https://potato-music.onrender.com";
    let currentId = "";
    let dragSrcEl;

    async function loadPlaylist() {
      const res = await fetch(API + "/api/playlist");
      const data = await res.json();
      const statusRes = await fetch(API + "/api/status");
      const status = await statusRes.json();
      currentId = status.id;

      const tbody = document.getElementById("playlistTable");
      tbody.innerHTML = "";

      data.forEach(track => {
        const row = document.createElement("tr");
        row.setAttribute("draggable", true);
        row.dataset.id = track.id;
        if (track.id === currentId) row.classList.add("highlight");
        row.innerHTML = `
          <td>${track.title}</td>
          <td>${track.id}</td>
          <td><button onclick="removeSong('${track.id}')">ì‚­ì œ</button></td>
        `;

        row.addEventListener("dragstart", e => {
          dragSrcEl = row;
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text/plain", row.dataset.id);
          row.classList.add("dragging");
        });

        row.addEventListener("dragend", () => row.classList.remove("dragging"));

        row.addEventListener("dragover", e => e.preventDefault());

        row.addEventListener("drop", async e => {
          e.preventDefault();
          const draggedId = e.dataTransfer.getData("text/plain");
          const targetId = row.dataset.id;
          if (draggedId === targetId) return;

          const res = await fetch(API + "/api/playlist");
          let list = await res.json();
          const draggedIdx = list.findIndex(item => item.id === draggedId);
          const targetIdx = list.findIndex(item => item.id === targetId);
          const [moved] = list.splice(draggedIdx, 1);
          list.splice(targetIdx, 0, moved);

          await fetch(API + "/api/debug/data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ...readData(), playlist: list })
          });

          loadPlaylist();
        });

        tbody.appendChild(row);
      });
    }

    async function addSong() {
      const id = document.getElementById("videoIdInput").value.trim();
      const title = document.getElementById("titleInput").value.trim();
      if (!id || !title) return alert("ê³¡ ID ë˜ëŠ” ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      await fetch(API + "/api/playlist", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, title })
      });
      document.getElementById("videoIdInput").value = "";
      document.getElementById("titleInput").value = "";
      loadPlaylist();
    }

    async function removeSong(id) {
      await fetch(API + "/api/playlist/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      });
      loadPlaylist();
    }

    async function play() {
      const res = await fetch(API + "/api/playlist");
      const playlist = await res.json();
      if (!playlist.length) return alert("í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
      const track = playlist[0];
      const payload = {
        id: track.id,
        title: track.title,
        startTime: Math.floor(Date.now() / 1000),
        isPaused: false
      };
      await fetch(API + "/api/play", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      loadPlaylist();
    }

    function pause() {
      fetch(API + "/api/pause", { method: "POST" });
    }

    function next() {
      alert("â›‰ ë‹¤ìŒ ê³¡ ê¸°ë³¸ì  ëª©ë¡ì€ ì—†ìŠµë‹ˆë‹¤.\nê·œì¹™ì„ ë“œëŠ” í”„ë¡œê·¸ë¨ì´ ì•„ë‹ˆë¼\nê°œë°œìê°€ â€˜ì‹ ë¢°ê°€ ê·¸ ì‹œê°„ê³¼ idâ€™ë¥¼ í•˜ë‚˜ë¥¼ ê³¨ë¼ê°€ë©´ ë‹¤ìŒ ê³¡ì„ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    }

    function seek() {
      const sec = parseInt(document.getElementById("seekSeconds").value || "0");
      fetch(API + "/api/status")
        .then(res => res.json())
        .then(status => {
          if (!status.id) return alert("ê°€ì¥ ë§ˆì§€ë§‰ì´ ë³´ì´ì§€ ì•ŠìŒ");
          const payload = {
            type: "seek",
            id: status.id,
            title: status.title,
            startTime: Math.floor(Date.now() / 1000) - sec,
            isPaused: status.isPaused || false
          };
          const ws = new WebSocket("wss://potato-music.onrender.com");
          ws.onopen = () => ws.send(JSON.stringify(payload));
        });
    }

    loadPlaylist();
  </script>
</body>
</html>
