<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Potato Music</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #fff; }
    #player { width: 480px; height: 270px; margin-top: 30px; }
    #nowPlaying { font-weight: bold; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>Potato Music 🎵</h2>
  <div id="nowPlaying">현재 재생 중: 없음</div>
  <div id="player"></div>

  <script>
    const API_BASE = "https://potato-music.onrender.com";
    let player;
    let ws;
    let currentId = "";
    let currentTitle = "";
    let lastReportedTime = 0;

    function connectWebSocket() {
      ws = new WebSocket("wss://potato-music.onrender.com");

      ws.onopen = () => console.log("✅ WebSocket 연결됨");
      ws.onclose = () => {
        console.log("🔌 WebSocket 종료됨, 재연결 시도 중...");
        setTimeout(connectWebSocket, 2000);
      };
    }

    function sendWSMessage(msg) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(msg));
      }
    }

    function onYouTubeIframeAPIReady() {
      player = new YT.Player("player", {
        height: "270",
        width: "480",
        videoId: "",
        playerVars: { autoplay: 1, mute: 1, playsinline: 1 },
        events: {
          onReady: () => {
            fetch(API_BASE + "/api/status")
              .then(res => res.json())
              .then(status => {
                if (status?.id) {
                  const elapsed = Math.floor(Date.now() / 1000) - status.startTime;
                  currentId = status.id;
                  currentTitle = status.title;
                  player.loadVideoById(currentId);
                  player.seekTo(elapsed, true);
                  if (!status.isPaused) player.playVideo();
                  document.getElementById("nowPlaying").textContent = "현재 재생 중: " + currentTitle;
                }
              });
          },
          onStateChange: (event) => {
            if (event.data === YT.PlayerState.ENDED) {
              fetch(API_BASE + "/api/playlist")
                .then(res => res.json())
                .then(songs => {
                  const index = songs.findIndex(s => s.id === currentId);
                  if (index + 1 < songs.length) {
                    const next = songs[index + 1];
                    currentId = next.id;
                    currentTitle = next.title;
                    sendWSMessage({ type: "play", id: next.id, title: next.title, startTime: Math.floor(Date.now() / 1000), isPaused: false });
                  } else {
                    sendWSMessage({ type: "pause" });
                  }
                });
            }
          }
        }
      });

      // 🕒 seeker 변화 실시간 감지 및 broadcast
      setInterval(() => {
        if (!player || typeof player.getCurrentTime !== "function") return;
        const current = Math.floor(player.getCurrentTime());

        if (Math.abs(current - lastReportedTime) > 2 && currentId) {
          const startTime = Math.floor(Date.now() / 1000) - current;
          sendWSMessage({ type: "seek", id: currentId, title: currentTitle, startTime, isPaused: false });
          lastReportedTime = current;
        }
      }, 2000);
    }

    connectWebSocket();

    const tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
  </script>
</body>
</html>
