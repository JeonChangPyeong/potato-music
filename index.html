<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Potato Music</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f4f4f4;
    }
    #playlist {
      margin-top: 20px;
    }
    .song {
      padding: 5px;
      border-bottom: 1px solid #ccc;
    }
    .song-title {
      font-weight: bold;
    }
    .song-controls {
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>Potato Music 관리자</h1>

  <div>
    <input type="text" id="videoId" placeholder="유튜브 영상 ID" />
    <input type="text" id="videoTitle" placeholder="곡 제목" />
    <button id="addBtn">곡 추가</button>
  </div>

  <div id="playlist"></div>

  <div style="margin-top: 30px;">
    <div id="player"></div>
    <button id="pauseBtn">일시정지</button>
  </div>

  <script>
    const API = "https://potato-music.onrender.com";
    const socket = new WebSocket("wss://potato-music.onrender.com");
    let player;

    // 유튜브 API 스크립트 삽입
    const tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    function onYouTubeIframeAPIReady() {
      player = new YT.Player("player", {
        height: "270",
        width: "480",
        videoId: "",
        playerVars: {
          controls: 1,
          rel: 0,
        },
      });
    }

    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

    socket.onopen = () => {
      console.log("웹소켓 연결됨");
    };

    document.getElementById("addBtn").onclick = () => {
      const id = document.getElementById("videoId").value.trim();
      const title = document.getElementById("videoTitle").value.trim();
      if (!id || !title) return;

      fetch(API + "/api/playlist", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, title }),
      }).then(loadPlaylist);
    };

    function loadPlaylist() {
      fetch(API + "/api/playlist")
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById("playlist");
          container.innerHTML = "";
          data.forEach(song => {
            const div = document.createElement("div");
            div.className = "song";
            div.innerHTML = `
              <div class="song-title">${song.title}</div>
              <div class="song-controls">
                <button onclick="playSong('${song.id}', '${song.title}')">재생</button>
                <button onclick="deleteSong('${song.id}')">삭제</button>
              </div>
            `;
            container.appendChild(div);
          });
        });
    }

    function playSong(id, title) {
      const startTime = Math.floor(Date.now() / 1000);
      socket.send(JSON.stringify({ type: "play", id, title, startTime, isPaused: false }));
    }

    function deleteSong(id) {
      fetch(API + "/api/playlist/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id }),
      }).then(loadPlaylist);
    }

    document.getElementById("pauseBtn").onclick = () => {
      fetch(API + "/api/pause", { method: "POST" });
    };

    // ✅ 백그라운드 복귀 시 강제 재생 시도
    document.addEventListener("visibilitychange", () => {
      if (!document.hidden && player && typeof player.playVideo === "function") {
        player.playVideo();
      }
    });

    loadPlaylist();
  </script>
</body>
</html>
